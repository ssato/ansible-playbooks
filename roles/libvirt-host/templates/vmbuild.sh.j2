#! /bin/bash
# see also virt-install(1)
set -ex
test $# -gt 0 && ks_path=$1 || ks_path=${0%/*}/ks.cfg
kscfg=${ks_path##*/}
name={{ _guest.name }}
connect=qemu:///system
location_opts="--location={{ _guest.install_iso }} --initrd-inject=${ks_path}"
extra_args="inst.loglevel=debug inst.headless inst.text inst.ks=file:/${kscfg} "

virt-install \
--check-cpu --hvm --accelerate --noautoconsole \
--name=${name:?} \
--connect=${connect:?} \
--arch=x86_24 \
--wait={{ _guest.virtinst_waittime|default('10') }} \
--ram={{ _guest.virtinst_ram|default('1024') }} \
--vcpus={{ _guest.virtinst_vcpus|default('1') }} \
{{ ' --cpu %s' % _guest.virtinst_cpu|default('host') }} \
--graphics "{{ _guest.virtinst_graphics|default('vnc') }},keymap=us" \
--os-type=linux \
--os-variant={{ _guest.virtinst_os_variant|default('rhel7') }} \
--controller=scsi,model=virtio-scsi \
${location_opts} \
--extra-args="${extra_args}" \
--disk pool=default,format=qcow2,cache=none,size={{ _guest.disk_0|default('20') }},bus={{ _guest.disk_0_bus|default('virtio') }} \
--network network={{ _guest.libvirt_network|default('default') }},model=virtio,mac={{ _guest.mac_0 }} \

# vim:sw=2:ts=2:et:
